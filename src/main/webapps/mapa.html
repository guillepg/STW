<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Mapa central TP6 STW</title>
  <script type="text/javascript" src="zepto.min.js"></script>
  <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=true"></script>
  <script type="text/javascript" src="gmaps.js"></script>
  <link rel="stylesheet" type="text/css" href="mypath.css" />
  <script type="text/javascript">
    var map, lat, lng, lat1, lng1;
	
    $(function(){
		
		$("#dibujar").on('click', crearLista);
		
		function enlazarMarcador(e){
			// muestra ruta entre marcas anteriores y actuales
			map.drawRoute({
			  origin: [lat, lng],  // origen en coordenadas anteriores
			  // destino en coordenadas del click o toque actual
			  destination: [e.latLng.lat(), e.latLng.lng()],
			  travelMode: 'driving',
			  strokeColor: '#000000',
			  strokeOpacity: 0.6,
			  strokeWeight: 5
			});

			lat = e.latLng.lat();   // guarda coords para marca siguiente
			lng = e.latLng.lng();

			map.addMarker({ lat: lat, lng: lng});  // pone marcador en mapa
		};

		function compactarRuta(){
			map.cleanRoute();
			map.removeMarkers();
			map.addMarker({ lat: lat1, lng: lng1});
			map.addMarker({ lat: lat, lng: lng});
			map.drawRoute({
				origin: [lat1, lng1],
				destination: [lat, lng],
				travelMode: 'driving',
				strokeColor: '#FF0000',
				strokeOpacity: 0.8,
				strokeWeight: 5
			});
		}
		
		function geolocalizar(){
			GMaps.geolocate({
				success: function(position){
					lat = position.coords.latitude;  // guarda coords en lat y lng
					lng = position.coords.longitude;
					lat1 = lat; lng1 = lng;
					map = new GMaps({  // muestra mapa centrado en coords [lat, lng]
						el: '#map',
						lat: lat,
						lng: lng,
						click: enlazarMarcador,
						tap: enlazarMarcador
					});
					map.addMarker({ lat: lat, lng: lng});  // marcador en [lat, lng]
				}, error: function(error) { alert('Geolocalización falla: '+error.message); },
				not_supported: function(){ alert("Su navegador no soporta geolocalización"); },
			});
		};
		
		function crearLista(e){
			xhttp=new XMLHttpRequest();
			xhttp.open("GET",
			"http://www.zaragoza.es/api/recurso/urbanismo-infraestructuras/estacion-bicicleta.json?fl=id,estado,bicisDisponibles,anclajesDisponibles,icon,title,geometry&rows=130&srsname=wgs84",false);
			xhttp.send();
			var documento=xhttp.responseText;
			dibujarMapa(documento);
		}
		
		function dibujarMapa(documento){
			var obj = JSON.parse(documento);
			var ini = obj.start; var total = obj.rows; 
			
			for(var line = ini; line < total; line++){
			
				map.addMarker({ lat: obj.result[line].geometry.coordinates[1], 
								lng: obj.result[line].geometry.coordinates[0],
								title: obj.result[line].title,
								
								infoWindow: {content: '<p>ID de estacion: '+obj.result[line].id+
														'</p><p>Ubicacion: '+obj.result[line].title+
														'</p><p>Estado: '+obj.result[line].estado+
														'</p><p>Bicis disponibles: '+obj.result[line].bicisDisponibles+
														'</p><p>Anclajes disponibles: '+obj.result[line].anclajesDisponibles+'</p>'},
								icon: "http://www.zaragoza.es/contenidos/iconos/bizi/conbicis.png"
								});
			}
			
		};
		//enlace 1: http://stackoverflow.com/questions/17604071/parse-xml-using-javascript
		//enlace 2: http://stackoverflow.com/questions/8390855/how-to-instantiate-a-file-object-in-javascript
		//enlace 3: http://stackoverflow.com/questions/7949752/cross-browser-javascript-xml-parsing
		geolocalizar();
	});
  </script>
</head>
<body>
	<button type="button" id="compactar" align="left"> Compactar ruta</button>
	<button type="button" id="dibujar" align="right"> Dibujar puntos</button>
	<h1 align="center">Prueba mapa estaciones Bizi</h1>
  <div id="map" width="800" height="600"></div>
</body>
</html>
